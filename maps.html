<!DOCTYPE html>
<html>
<head>
    <title>AR Path Navigation</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        /* UI Overlay Design */
        .hud {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 999;
            font-family: sans-serif;
            pointer-events: none;
        }
        .instruction-box {
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00; /* Bright Green */
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.1rem;
            display: inline-block;
            border: 2px solid #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        .sub-text {
            display: block;
            font-size: 0.9rem;
            color: #ddd;
            margin-top: 5px;
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>

    <div class="hud">
        <div class="instruction-box" id="msg">
            Initializing System...
            <span class="sub-text">Waiting for GPS Signal</span>
        </div>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'>

        <a-camera gps-camera="gpsMinDistance: 3" rotation-reader id="camera">
            
            <a-entity 
                id="guide-arrow"
                visible="false"
                geometry="primitive: cone; radiusBottom: 0.15; height: 0.5"
                material="color: #ff0000; opacity: 1.0; shader: flat;"
                position="0 -0.5 -1.5"
                rotation="90 0 0"> </a-entity>

        </a-camera>

    </a-scene>

    <script>
        // ============================================
        // âš ï¸ STEP 1: PASTE YOUR MAPBOX TOKEN HERE
        // ============================================
        const MAPBOX_TOKEN = 'PASTE_YOUR_TOKEN_HERE'; 


        // ============================================
        // âš ï¸ STEP 2: SET DESTINATION [Longitude, Latitude]
        // ============================================
        const DESTINATION = [79.1559, 12.9692]; // Example: VIT Main Gate


        // ============================================
        // LOGIC (DO NOT TOUCH)
        // ============================================
        let routePoints = [];
        let nextPointIndex = 0;

        window.onload = () => {
            const msgBox = document.querySelector('#msg');
            const arrow = document.querySelector('#guide-arrow');
            const camera = document.querySelector('#camera');

            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(async (position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;

                    // A. Fetch Path (One Time)
                    if (routePoints.length === 0) {
                        msgBox.innerHTML = "Fetching Path...<br><span class='sub-text'>Contacting Mapbox</span>";
                        await getPathFromMapbox(userLon, userLat);
                    }

                    // B. Navigation Loop
                    if (routePoints.length > 0) {
                        const target = routePoints[nextPointIndex];
                        const dist = calculateDistance(userLat, userLon, target[1], target[0]);

                        // Update Text
                        msgBox.innerHTML = `Next Point: ${Math.round(dist)}m<br><span class='sub-text'>Follow Red Arrow</span>`;
                        arrow.setAttribute('visible', 'true');

                        // Checkpoint Logic (< 10m)
                        if (dist < 10) {
                            if (nextPointIndex < routePoints.length - 1) {
                                nextPointIndex++;
                                msgBox.innerHTML = "Turn Reached!<br><span class='sub-text'>New Direction...</span>";
                            } else {
                                msgBox.innerHTML = "ðŸŽ‰ ARRIVED! ðŸŽ‰<br><span class='sub-text'>Welcome to the Venue</span>";
                                arrow.setAttribute('visible', 'false');
                            }
                        }

                        // C. Compass Logic (Rotate Arrow)
                        // 1. Where should we go? (Bearing to Target)
                        const targetBearing = calculateBearing(userLat, userLon, target[1], target[0]);
                        
                        // 2. Where are we looking? (Camera Heading)
                        // Note: We need the Y-rotation of the camera
                        const currentRotation = camera.getAttribute('rotation');
                        const userHeading = currentRotation ? currentRotation.y : 0;

                        // 3. Difference = Where the arrow should point on screen
                        const relativeHeading = targetBearing - userHeading;

                        // 4. Apply Rotation (Convert to Radians)
                        // We use negative relativeHeading because A-Frame rotates CCW
                        arrow.object3D.rotation.y = THREE.Math.degToRad(-relativeHeading);
                        
                        // Keep arrow flat (X-axis 90deg)
                        arrow.object3D.rotation.x = THREE.Math.degToRad(90); 
                    }

                }, (err) => {
                    console.error(err);
                    msgBox.innerHTML = "GPS Error<br><span class='sub-text'>Check Location Settings</span>";
                }, { enableHighAccuracy: true });
            }
        };

        // --- API & MATH FUNCTIONS ---
        async function getPathFromMapbox(startLon, startLat) {
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${startLon},${startLat};${DESTINATION[0]},${DESTINATION[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    routePoints = data.routes[0].geometry.coordinates;
                } else {
                    document.querySelector('#msg').innerText = "No Route Found!";
                }
            } catch (error) { console.error(error); }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }
    </script>
</body>
</html>
