<!DOCTYPE html>
<html>
<head>
    <title>AR Path Navigation</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        .hud {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }
        .instruction-box {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
            font-family: sans-serif;
            font-size: 1.2rem;
            border: 2px solid #d4af37;
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>

    <div class="hud">
        <div class="instruction-box" id="instruction">Loading Path...</div>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'>

        <a-camera gps-camera="gpsMinDistance: 3" rotation-reader></a-camera>

        <a-entity 
            id="guide-arrow"
            visible="false"
            geometry="primitive: cone; radiusBottom: 0.2; height: 1.0"
            material="color: #00ff00; opacity: 0.9"
            position="0 -1 -3"> </a-entity>

    </a-scene>

    <script>
        // ==========================================
        // CONFIGURATION: YOUR PATH
        // ==========================================
        // Add coordinates for the turns. 
        // [0] is Start, [Last] is Destination.
        const PATH = [
            { lat: 12.972442, lon: 79.158733 }, // Point A (e.g., Building Corner)
            { lat: 12.972500, lon: 79.158800 }, // Point B (e.g., Road Turn)
            { lat: 12.969200, lon: 79.155900 }  // Final Destination
        ];

        let currentPointIndex = 0; // We start tracking the first point

        window.onload = () => {
            const arrow = document.querySelector('#guide-arrow');
            const hud = document.querySelector('#instruction');
            
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    
                    // Get the current target point on the path
                    const target = PATH[currentPointIndex];

                    // 1. Calculate Distance to current target
                    const dist = calculateDistance(userLat, userLon, target.lat, target.lon);

                    // 2. Logic: Have we reached this point? (Threshold: 10 meters)
                    if (dist < 10) {
                        if (currentPointIndex < PATH.length - 1) {
                            // Yes! Switch to NEXT point
                            currentPointIndex++;
                            hud.innerText = "Checkpoint Reached! Turning...";
                            // Play a sound or vibrate here if you want
                        } else {
                            // No more points - we finished!
                            hud.innerText = "ðŸŽ‰ DESTINATION REACHED! ðŸŽ‰";
                            arrow.setAttribute('visible', 'false');
                            return; // Stop updating
                        }
                    }

                    // 3. Navigation Update
                    const bearing = calculateBearing(userLat, userLon, target.lat, target.lon);
                    
                    // Update Text
                    hud.innerText = `Go to Point ${currentPointIndex + 1} (${Math.round(dist)}m)`;

                    // 4. Update Arrow Orientation
                    // We simply rotate the arrow to match the bearing relative to North
                    // Note: This assumes the user is facing North. To make it truly "Device Orientation" dependent
                    // requires fusing the compass sensor, which A-Frame handles via 'look-controls'.
                    // For a ground arrow, we often just update its rotation.
                    arrow.setAttribute('visible', 'true');
                    
                    // This rotation logic aligns the arrow with the bearing
                    // In WebAR, getting the arrow to point "Real World North" vs "Screen North" is tricky.
                    // This is a simplified "Compass Arrow" approach.
                    arrow.object3D.rotation.y = THREE.Math.degToRad(-bearing);

                }, (err) => {
                    console.error("GPS Error", err);
                    hud.innerText = "GPS Error: " + err.message;
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                });
            }
        };

        // --- MATH HELPERS ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                      Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }
    </script>
</body>
</html>