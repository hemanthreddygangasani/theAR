<!DOCTYPE html>
<html>
<head>
    <title>AR Path Navigation</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        /* Heads-Up Display (HUD) Design */
        .hud {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 999;
            font-family: sans-serif;
            pointer-events: none; 
        }
        .instruction-box {
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00; /* Bright Green Text */
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.1rem;
            display: inline-block;
            border: 2px solid #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        .sub-text {
            display: block;
            font-size: 0.9rem;
            color: #ddd;
            margin-top: 5px;
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden;'>

    <div class="hud">
        <div class="instruction-box" id="msg">
            Initializing GPS...
            <span class="sub-text">Waiting for satellites</span>
        </div>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'>

        <a-camera gps-camera="gpsMinDistance: 3" rotation-reader></a-camera>

        <a-entity 
            id="guide-arrow"
            visible="false"
            geometry="primitive: cone; radiusBottom: 0.2; height: 1.0"
            material="color: #ff0000; opacity: 1.0"
            position="0 -1 -4"> 
        </a-entity>

    </a-scene>

    <script>
        // ==================================================================
        // âš ï¸ STEP 1: PASTE YOUR MAPBOX TOKEN HERE
        // It should look like: 'pk.eyJ1...'
        // ==================================================================
        
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiaGVtYW50aDg1MDMiLCJhIjoiY21rNzY0b2xnMHhlNzNkcXh2NXFzMXQ5ZiJ9.Wmuoh9GHMrMKo_lLmJ7oAA'; 


        // ==================================================================
        // âš ï¸ STEP 2: SET DESTINATION (Format: [Longitude, Latitude])
        // NOTE: Mapbox uses [Lon, Lat]. Google Maps gives you [Lat, Lon].
        // YOU MUST SWAP THEM! 
        // Example: If Google says "12.97, 79.15" -> You write [79.15, 12.97]
        // ==================================================================
        
        const DESTINATION = [79.1559, 12.9692]; // Example: VIT Main Gate


        // ==================================================================
        // SYSTEM LOGIC (DO NOT TOUCH BELOW THIS LINE)
        // ==================================================================

        let routePoints = [];
        let nextPointIndex = 0;

        window.onload = () => {
            const msgBox = document.querySelector('#msg');
            const arrow = document.querySelector('#guide-arrow');

            // Check if Geolocation is available
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(async (position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;

                    // A. Fetch Path (Only once at start)
                    if (routePoints.length === 0) {
                        msgBox.innerHTML = "Fetching Path...<br><span class='sub-text'>Contacting Mapbox</span>";
                        await getPathFromMapbox(userLon, userLat);
                    }

                    // B. Navigation Logic
                    if (routePoints.length > 0) {
                        // Get the target point on the path
                        const target = routePoints[nextPointIndex];
                        
                        // Calculate distance to that specific turn
                        const dist = calculateDistance(userLat, userLon, target[1], target[0]);

                        // Update UI
                        msgBox.innerHTML = `Next Point: ${Math.round(dist)}m ahead<br><span class='sub-text'>Follow Red Arrow</span>`;
                        arrow.setAttribute('visible', 'true');

                        // C. Checkpoint Logic (Did we reach the point?)
                        // If within 10 meters, switch to the NEXT point
                        if (dist < 10) {
                            if (nextPointIndex < routePoints.length - 1) {
                                nextPointIndex++;
                                msgBox.innerHTML = "Checkpoint Reached!<br><span class='sub-text'>Turning...</span>";
                            } else {
                                msgBox.innerHTML = "ðŸŽ‰ ARRIVED! ðŸŽ‰<br><span class='sub-text'>Welcome to the Venue</span>";
                                arrow.setAttribute('visible', 'false');
                            }
                        }

                        // D. Rotate the Arrow
                        // Calculate bearing from User to Target Point
                        const bearing = calculateBearing(userLat, userLon, target[1], target[0]);
                        
                        // Apply rotation (Convert to radians, invert for WebGL)
                        arrow.object3D.rotation.y = THREE.Math.degToRad(-bearing);
                    }

                }, (err) => {
                    console.error(err);
                    msgBox.innerHTML = "GPS Access Denied<br><span class='sub-text'>Please enable Location</span>";
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                });
            }
        };

        // --- API FUNCTION ---
        async function getPathFromMapbox(startLon, startLat) {
            // Mapbox API URL (Walking Mode)
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${startLon},${startLat};${DESTINATION[0]},${DESTINATION[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    routePoints = data.routes[0].geometry.coordinates;
                    console.log("Path Loaded:", routePoints.length, "points");
                } else {
                    document.querySelector('#msg').innerText = "No Route Found!";
                }
            } catch (error) {
                console.error("API Error:", error);
                document.querySelector('#msg').innerText = "Mapbox Error (Check Console)";
            }
        }

        // --- MATH FUNCTIONS ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                      Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }
    </script>
</body>
</html>